{"key":"lmoverview","name":"Manager overview","instructions":"","requirecss":"","requirejs":"https://www.gstatic.com/charts/loader.js","shim":"","defaults":"","amd":"0","body":"<div\n    id=\"@@AUTOID@@\"\n    class=\"lm-chart\"\n></div>","bodyend":"","script":"$(function () {\n    const autoid = '@@AUTOID@@';\n    const root = $(`#${autoid}`);\n\n    const fullDataset = '@@DATASET@@';\n    const dataset = Object.values(fullDataset)[0];\n\n    if (dataset.total <= 0) {\n        root.append('<div class=\"alert alert-success\">You currently do not have any staff reporting to you.</div>');\n\n        return;\n    }\n\n    google.charts.load('current', { 'packages': [ 'gauge' ] });\n    google.charts.setOnLoadCallback(drawChart);\n\n    function drawChart() {\n        const percent = Math.floor((dataset.current / dataset.total) * 100);\n\n        const data = google.visualization.arrayToDataTable([\n            [ 'Label', 'Value' ],\n            [ 'Current', percent ],\n        ]);\n\n        const options = {\n            width: 500, height: 150,\n            redFrom: 0, redTo: 70,\n            yellowFrom: 70, yellowTo: 80,\n            greenFrom: 80, greenTo: 100,\n            minorTicks: 5,\n        };\n\n        const chart = new google.visualization.Gauge(document.getElementById(autoid));\n        chart.draw(data, options);\n\n        root.prepend('<p style=\"text-align: center;\"><strong>My staff compliance</strong></p>');\n    }\n});","style":".lm-chart table {\n    margin: 0 auto !important;\n}","dataset":"SELECT  SUM(\n            CASE\n                WHEN records.enddate IS NOT NULL THEN 0\n                WHEN records.delay = 0 THEN 1\n                WHEN records.timecreated < records.delay THEN 1\n            END\n        ) AS 'total',\n        SUM(\n            CASE\n                WHEN records.enddate IS NOT NULL THEN 0\n                WHEN records.timecreated > records.delay AND records.delay > 1 THEN 0\n                WHEN records.expiry = 0 AND records.timecompleted > 1 THEN 1\n                WHEN records.timecompleted > records.expiry THEN 1\n                ELSE 0\n            END\n        ) AS 'current'\nFROM    (\n            SELECT  DISTINCT u.username AS 'payroll',\n                    u.timecreated,\n                    c.fullname AS 'course',\n                    IF(\n                        GREATEST(COALESCE(cc.timecompleted, 0), COALESCE(MAX(lrc.timecompleted), 0)) = 0,\n                        NULL,\n                        GREATEST(COALESCE(cc.timecompleted, 0), COALESCE(MAX(lrc.timecompleted), 0))\n                    ) AS 'timecompleted',\n                    CASE\n                        WHEN tpc.expiry = 0 THEN 0\n                        WHEN tpc.expiryformat = 7 THEN UNIX_TIMESTAMP(NOW() - interval tpc.expiry year)\n                        WHEN tpc.expiryformat = 6 THEN UNIX_TIMESTAMP(NOW() - interval tpc.expiry month)\n                        WHEN tpc.expiryformat = 5 THEN UNIX_TIMESTAMP(NOW() - interval tpc.expiry week)\n                    END AS 'expiry',\n                    CASE\n                        WHEN tpc.delay = 0 THEN 0\n                        WHEN tpc.delayformat = 7 THEN UNIX_TIMESTAMP(NOW() - interval tpc.delay year)\n                        WHEN tpc.delayformat = 6 THEN UNIX_TIMESTAMP(NOW() - interval tpc.delay month)\n                        WHEN tpc.delayformat = 5 THEN UNIX_TIMESTAMP(NOW() - interval tpc.delay week)\n                        WHEN tpc.delayformat = 4 THEN UNIX_TIMESTAMP(NOW() - interval tpc.delay day)\n                    END AS 'delay',\n                    exempt.enddate\n\n            FROM    {course} c\n                    JOIN {tool_trainingplan_courses} tpc ON\n                        tpc.courseid = c.id\n                    JOIN {tool_trainingplan_cohorts} tpcoh ON\n                        tpcoh.planid = tpc.planid\n                    JOIN {cohort_members} cm ON\n                        cm.cohortid = tpcoh.cohortid\n\n                    JOIN {user} u ON\n                        u.id = cm.userid\n\n                    JOIN {tool_organisation_assign} toa ON\n                        toa.userid = u.id\n\n                    JOIN {tool_organisation_positions} top ON\n                        top.id = toa.positionid\n\n                    JOIN {tool_organisation_mtda_pos} position ON\n                        position.positionid = toa.positionid\n\n                    LEFT JOIN {tool_organisation_roles} roles ON\n                        roles.levelid = position.unitid AND\n                        (\n                            roles.manager = 1 OR\n                            roles.manageusers = 1 OR\n                            roles.viewreports = 1\n                        )\n\n                    LEFT JOIN {tool_organisation_assign} toam ON\n                        toam.positionid = roles.positionid\n\n                    LEFT JOIN {user} manager ON\n                        manager.id = toam.userid\n\n                    LEFT JOIN {tool_trainingplan_exemptions} exempt ON\n                        exempt.userid = u.id AND\n                        exempt.courseid = c.id AND\n                        exempt.enddate > UNIX_TIMESTAMP()\n\n                    LEFT JOIN {course_completions} cc ON\n                        cc.userid = u.id AND\n                        cc.course = c.id\n\n                    LEFT JOIN {local_recompletion_cc} lrc ON\n                        lrc.userid = u.id AND\n                        lrc.course = c.id\n\n            WHERE   manager.id = ? AND\n                    u.suspended = 0 AND\n                    c.visible = 1\n\n            GROUP BY u.id, c.id\n        ) records","datasetvars":"@@USER:id@@","alternate":"","alternateend":"","version":"1.2.0"}