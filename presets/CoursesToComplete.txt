{"key":"coursestocomplete","name":"Courses to complete","instructions":"","requirecss":"","requirejs":"","shim":"","defaults":"","amd":"1","body":"<div id=\"@@AUTOID@@\">","bodyend":"</div>","script":"$(function () {\n    var courses = @@DATASET@@;\n    var root = $('#' + @@AUTOID@@);\n\n    root.append('<table id=\"tbl_' + @@AUTOID@@ + '\" class=\"generaltable\"><tbody id=\"tby_' + @@AUTOID@@ + '\"></tbody></table>');\n\n    var statusicon = 'fa-times-circle';\n    var statusclass = 'text-danger';\n    var statustext = 'Not completed';\n\n    if (courses) {\n        $.each(courses, function (key, course) {\n            if (course.status === 'expired') {\n                statusicon = 'fa-exclamation-circle';\n                statusclass = 'text-warning';\n                statustext = 'Expired: Last completed ' + course.datecompleted;\n            }\n            if (course.status === 'Not completed') {\n                statusicon = 'fa-times-circle';\n                statusclass = 'text-danger';\n                statustext = 'Not completed';\n            }\n            if (course.status === 'expiring soon') {\n                statusicon = 'fa-exclamation-circle';\n                statusclass = 'text-success';\n                statustext = 'Expiring soon: Last completed ' + course.datecompleted;\n            }\n\n            $('#tby_' + @@AUTOID@@).append(\n                '<tr>' +\n                '<td class=\"text-left\"><a href=\"' + @@WWWROOT@@ + '/course/view.php?id=' + course.id + '\">' + course.fullname + '</a></td>' +\n                '<td class=\"text-center\"><i class=\"fa ' + statusicon + ' ' + statusclass + '\" style=\"font-size: 2em;\" aria-hidden=\"true\" data-toggle=\"tooltip\" data-placement=\"top\" title=\"' + statustext + '\"></i></td>' +\n                '</tr>'\n            );\n        });\n    } else {\n        root.append('<div class=\"alert alert-success\">You have no outstanding mandatory training to complete.</div>');\n    }\n\n    root.append('<p><a href=\"' + @@WWWROOT@@ + '/local/lol/mgrrep.php\">Show more</a></p>');\n});","style":"","dataset":"SELECT  *\nFROM    (\n            SELECT  DISTINCT c.id,\n                    c.fullname,\n                    CASE\n                        WHEN cc.timecompleted > 0 THEN FROM_UNIXTIME(cc.timecompleted, '%d/%m/%Y')\n                        ELSE NULL\n                    END AS datecompleted,\n                    CASE\n                        WHEN exemptions.id IS NOT NULL THEN 'current'\n                        WHEN cc.timecompleted IS NULL THEN 'Not completed'\n                        WHEN cc.timecompleted = 0 THEN 'Not completed'\n                        WHEN tpc.expiry = 0 AND cc.timecompleted > 1 then 'current'\n                        WHEN tpc.expiryformat = 7 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry YEAR)) THEN 'expired'\n                        WHEN tpc.expiryformat = 7 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry YEAR))+4*604800 THEN 'expiring soon'\n                        WHEN tpc.expiryformat = 6 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry MONTH)) THEN 'expired'\n                        WHEN tpc.expiryformat = 6 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry MONTH))+4*604800 THEN 'expiring soon'\n                        WHEN tpc.expiryformat = 5 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry WEEK)) THEN 'expired'\n                        WHEN tpc.expiryformat = 5 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry WEEK))+4*604800 THEN 'expiring soon'\n                        WHEN tpc.expiryformat = 4 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry DAY)) THEN 'expired'\n                        WHEN tpc.expiryformat = 4 AND cc.timecompleted < UNIX_TIMESTAMP(DATE_SUB( CURDATE(), INTERVAL tpc.expiry DAY))+4*604800 THEN 'expiring soon'\n                        ELSE 'current'\n                    END AS status\n            FROM    {user} u\n                    INNER JOIN {cohort_members} cm ON\n                        cm.userid = u.id\n                    INNER JOIN {tool_trainingplan_cohorts} tpco ON\n                        tpco.cohortid = cm.cohortid\n                    INNER JOIN {tool_trainingplan_courses} tpc ON\n                        tpc.planid = tpco.planid\n                    INNER JOIN {course} c ON\n                        c.id = tpc.courseid\n\n                    LEFT JOIN (\n                        SELECT  ccg.userid,\n                                ccg.course,\n                                max(ccg.timecompleted) AS timecompleted\n                        FROM (\n                            SELECT  *\n                            FROM    (\n                                        SELECT  *\n                                        FROM    {course_completions} cc1\n                                        WHERE   cc1.userid = ?\n                                    UNION\n                                        SELECT  *\n                                        FROM    {local_recompletion_cc} lrc\n                                        WHERE   lrc.userid = ?\n                            ) cctot\n                            ORDER BY cctot.timecompleted DESC\n                        ) ccg\n                        GROUP BY ccg.course\n                    ) cc ON\n                        cc.course = c.id AND\n                        cc.userid = u.id\n\n                    LEFT JOIN {tool_trainingplan_exemptions} exemptions ON\n                        exemptions.courseid = c.id AND\n                        exemptions.userid = u.id AND\n                        (\n                            exemptions.enddate IS NULL OR\n                            exemptions.enddate >= UNIX_TIMESTAMP()\n                        )\n            WHERE   u.id = ? AND\n                    c.visible = 1\n            ORDER BY cc.timecompleted\n        ) a\nWHERE   a.status != 'current'\n","datasetvars":"@@USER:id@@,@@USER:id@@,@@USER:id@@","alternate":"","alternateend":"","version":"1.2.0"}